---
phase: 03-subscription-management
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/web/lib/stripe/subscription.ts
  - .env.example
autonomous: false

must_haves:
  truths:
    - "getSubscriptionStatus returns accurate status for free, paid, demo, and lifetime users"
    - "Yearly subscription expiry is calculated from lastPayment + 1 year"
    - "Lifetime users always show as active with no expiry"
    - "Environment example documents new payment link variables"
  artifacts:
    - path: "apps/web/lib/stripe/subscription.ts"
      provides: "Subscription status helper function"
      exports: ["getSubscriptionStatus", "SubscriptionStatus"]
    - path: ".env.example"
      provides: "Documentation for payment link env vars"
      contains: "NEXT_PUBLIC_STRIPE_YEARLY_LINK"
  key_links:
    - from: "apps/web/lib/stripe/subscription.ts"
      to: "@bragdoc/database/schema"
      via: "User type import"
      pattern: "import.*User.*from"

user_setup:
  - service: stripe
    why: "Payment processing for yearly and lifetime plans"
    env_vars:
      - name: NEXT_PUBLIC_STRIPE_YEARLY_LINK
        source: "Stripe Dashboard -> Payment Links -> Create (for yearly product)"
      - name: NEXT_PUBLIC_STRIPE_LIFETIME_LINK
        source: "Stripe Dashboard -> Payment Links -> Create (for lifetime product)"
    dashboard_config:
      - task: "Create 'BragDoc Yearly' product ($45/year recurring)"
        location: "Stripe Dashboard -> Products -> Add product"
      - task: "Create 'BragDoc Lifetime' product ($99 one-time)"
        location: "Stripe Dashboard -> Products -> Add product"
      - task: "Create payment links for both products"
        location: "Stripe Dashboard -> Payment Links"
      - task: "Archive old Basic/Pro products (do NOT delete)"
        location: "Stripe Dashboard -> Products -> [product] -> Archive"
---

<objective>
Create subscription status helper for feature gating and UI display, document new payment link environment variables, and guide Stripe dashboard setup.

Purpose: The getSubscriptionStatus helper centralizes subscription logic that will be used by feature gates (Phase 4) and UI (Phase 5). Documenting env vars ensures deployment succeeds. Stripe dashboard setup creates the products needed for payments.
Output: Subscription helper function, updated .env.example, Stripe products ready for use.
</objective>

<execution_context>
@/Users/ed/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ed/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-subscription-management/03-RESEARCH.md

# Existing credit check patterns to follow
@apps/web/lib/credits/check.ts

# User schema for type reference
@packages/database/src/schema.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create subscription status helper</name>
  <files>apps/web/lib/stripe/subscription.ts</files>
  <action>
Create new file `apps/web/lib/stripe/subscription.ts`:

```typescript
import type { User } from '@bragdoc/database/schema';

export interface SubscriptionStatus {
  /** Whether user has active paid access (paid or demo level) */
  isActive: boolean;
  /** Type of subscription */
  type: 'free' | 'yearly' | 'lifetime' | 'demo';
  /** When yearly subscription expires (undefined for lifetime/demo/free) */
  expiresAt?: Date;
  /** Days until expiry for yearly subscriptions */
  daysRemaining?: number;
}

/**
 * Calculate subscription status for a user.
 * Used for feature gating and UI display.
 *
 * Rules:
 * - Demo users always have unlimited access
 * - Paid users with 'lifetime' renewalPeriod never expire
 * - Paid users with 'yearly' renewalPeriod expire 1 year after lastPayment
 * - Free users have credit-limited access
 * - Legacy basic/pro values are treated as free (migration not needed)
 */
export function getSubscriptionStatus(user: User): SubscriptionStatus {
  // Demo users always have unlimited access
  if (user.level === 'demo') {
    return { isActive: true, type: 'demo' };
  }

  // Free users (and legacy basic/pro) have credit-limited access
  if (user.level === 'free' || user.level === 'basic' || user.level === 'pro') {
    return { isActive: false, type: 'free' };
  }

  // Paid users: check renewal period
  if (user.level === 'paid') {
    // Lifetime never expires
    if (user.renewalPeriod === 'lifetime') {
      return { isActive: true, type: 'lifetime' };
    }

    // Yearly: check if within renewal window
    if (user.renewalPeriod === 'yearly' && user.lastPayment) {
      const lastPayment = new Date(user.lastPayment);
      const expiresAt = new Date(lastPayment);
      expiresAt.setFullYear(expiresAt.getFullYear() + 1);

      const now = new Date();
      const isActive = expiresAt > now;

      // Calculate days remaining
      const msRemaining = expiresAt.getTime() - now.getTime();
      const daysRemaining = Math.max(0, Math.ceil(msRemaining / (1000 * 60 * 60 * 24)));

      return { isActive, type: 'yearly', expiresAt, daysRemaining };
    }

    // Paid but no lastPayment or renewalPeriod - treat as expired yearly
    // This shouldn't happen in normal flow but handles edge cases
    return { isActive: false, type: 'yearly' };
  }

  // Default fallback (shouldn't reach here with valid enum)
  return { isActive: false, type: 'free' };
}

/**
 * Check if user has active unlimited access (not credit-limited).
 * Convenience function for feature gates.
 */
export function hasUnlimitedAccess(user: User): boolean {
  const status = getSubscriptionStatus(user);
  return status.isActive;
}
```

Key design decisions:
- Returns daysRemaining for UI "expires in X days" display
- Handles legacy basic/pro by treating as free
- hasUnlimitedAccess convenience wrapper for feature gates
- Type-safe with full User type import
  </action>
  <verify>TypeScript compiles: `pnpm --filter=@bragdoc/web build`</verify>
  <done>getSubscriptionStatus and hasUnlimitedAccess functions created and exported</done>
</task>

<task type="auto">
  <name>Task 2: Update .env.example with payment link variables</name>
  <files>.env.example</files>
  <action>
Read current .env.example and add new payment link environment variables.

Add in the Stripe section (or create one if not exists):

```env
# Stripe Payment Links
# Create these in Stripe Dashboard -> Payment Links
NEXT_PUBLIC_STRIPE_YEARLY_LINK=https://buy.stripe.com/xxx  # $45/year subscription
NEXT_PUBLIC_STRIPE_LIFETIME_LINK=https://buy.stripe.com/xxx  # $99 lifetime one-time

# (Remove or comment out old Basic/Pro link variables if present)
# NEXT_PUBLIC_STRIPE_BASIC_MONTHLY_LINK=  # DEPRECATED
# NEXT_PUBLIC_STRIPE_BASIC_YEARLY_LINK=   # DEPRECATED
# NEXT_PUBLIC_STRIPE_PRO_MONTHLY_LINK=    # DEPRECATED
# NEXT_PUBLIC_STRIPE_PRO_YEARLY_LINK=     # DEPRECATED
```

Also add inline comment explaining what the variables are for.
  </action>
  <verify>`.env.example` contains NEXT_PUBLIC_STRIPE_YEARLY_LINK and NEXT_PUBLIC_STRIPE_LIFETIME_LINK</verify>
  <done>Payment link environment variables documented in .env.example</done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <action>Create Stripe products and payment links in dashboard</action>
  <instructions>
**Stripe Dashboard Setup Required**

This step requires manual action in the Stripe Dashboard. Claude cannot access Stripe's dashboard UI.

**Step 1: Create Products**

1. Go to Stripe Dashboard -> Products -> Add product
2. Create "BragDoc Yearly":
   - Name: BragDoc Yearly
   - Pricing: $45.00 / year (recurring)
   - Lookup key: yearly (important for webhook)
3. Create "BragDoc Lifetime":
   - Name: BragDoc Lifetime
   - Pricing: $99.00 one-time
   - Lookup key: lifetime (important for webhook)

**Step 2: Create Payment Links**

1. Go to Stripe Dashboard -> Payment Links
2. Create payment link for BragDoc Yearly:
   - Select the yearly product
   - Copy the URL to NEXT_PUBLIC_STRIPE_YEARLY_LINK env var
3. Create payment link for BragDoc Lifetime:
   - Select the lifetime product
   - Copy the URL to NEXT_PUBLIC_STRIPE_LIFETIME_LINK env var

**Step 3: Archive Old Products (Optional)**

1. Go to Products
2. Find old Basic/Pro products
3. Click "..." -> Archive (NOT delete)

**When Complete:**

Add the payment links to your .env.local:
```
NEXT_PUBLIC_STRIPE_YEARLY_LINK=https://buy.stripe.com/your-yearly-link
NEXT_PUBLIC_STRIPE_LIFETIME_LINK=https://buy.stripe.com/your-lifetime-link
```

Reply "done" when complete, or describe any issues.
  </instructions>
  <resume-signal>Type "done" or describe issues encountered</resume-signal>
</task>

</tasks>

<verification>
1. `pnpm build` succeeds
2. `pnpm test` passes
3. getSubscriptionStatus returns correct values:
   - Demo user: { isActive: true, type: 'demo' }
   - Lifetime user: { isActive: true, type: 'lifetime' }
   - Yearly user (active): { isActive: true, type: 'yearly', expiresAt: ..., daysRemaining: ... }
   - Yearly user (expired): { isActive: false, type: 'yearly', ... }
   - Free user: { isActive: false, type: 'free' }
4. .env.example contains new payment link variables
5. Stripe dashboard has new products (after human action)
</verification>

<success_criteria>
- getSubscriptionStatus correctly identifies all user types
- Yearly expiry calculation is accurate (lastPayment + 1 year)
- Lifetime users never show as expired
- Payment link env vars are documented
- Stripe products exist in dashboard (after human action)
</success_criteria>

<output>
After completion, create `.planning/phases/03-subscription-management/03-03-SUMMARY.md`
</output>

---
phase: 02-credit-system
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/web/lib/credits/check.ts
  - apps/web/lib/credits/logger.ts
  - apps/web/lib/credits/index.ts
  - packages/database/src/queries/credit-transactions.ts
  - packages/database/src/queries/index.ts
autonomous: true

must_haves:
  truths:
    - "checkUserCredits returns accurate status for free, paid, and demo users"
    - "All credit operations are logged with userId, operation type, and timestamp"
    - "Transaction logs never contain PII (email, name, password)"
  artifacts:
    - path: "apps/web/lib/credits/check.ts"
      provides: "Credit checking utilities"
      exports: ["checkUserCredits", "checkUserChatMessages"]
    - path: "apps/web/lib/credits/logger.ts"
      provides: "Credit transaction logging"
      exports: ["logCreditTransaction"]
    - path: "packages/database/src/queries/credit-transactions.ts"
      provides: "Database queries for credit transaction table"
      exports: ["insertCreditTransaction", "getCreditTransactionsByUser"]
  key_links:
    - from: "apps/web/lib/credits/logger.ts"
      to: "packages/database/src/queries/credit-transactions.ts"
      via: "import and call"
      pattern: "insertCreditTransaction"
    - from: "apps/web/lib/credits/check.ts"
      to: "@bragdoc/database/schema"
      via: "User type import"
      pattern: "import.*User.*from"
---

<objective>
Create credit checking helpers and transaction logging for debugging and support.

Purpose: Implement the checkUserCredits() utility that properly handles free, paid, and demo users, plus transaction logging that records all credit operations for audit trails and debugging customer credit issues.

Output: Credit check utilities and a logging system that writes to the CreditTransaction table from Phase 1.
</objective>

<execution_context>
@/Users/ed/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ed/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-credit-system/02-RESEARCH.md

@packages/database/src/schema.ts
@apps/web/lib/getAuthUser.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create credit transaction database queries</name>
  <files>
    packages/database/src/queries/credit-transactions.ts
    packages/database/src/queries/index.ts
  </files>
  <action>
**credit-transactions.ts:** Create database query functions for the CreditTransaction table:

```typescript
import { db } from '../index';
import { creditTransaction } from '../schema';
import type { OperationType, FeatureType } from '../schema';
import { eq, desc } from 'drizzle-orm';

export interface CreditTransactionInput {
  userId: string;
  amount: number;
  operation: OperationType;
  featureType: FeatureType;
  metadata?: Record<string, unknown>;
}

export async function insertCreditTransaction(input: CreditTransactionInput) {
  const [result] = await db
    .insert(creditTransaction)
    .values({
      userId: input.userId,
      amount: input.amount,
      operation: input.operation,
      featureType: input.featureType,
      metadata: input.metadata ?? null,
    })
    .returning();
  return result;
}

export async function getCreditTransactionsByUser(
  userId: string,
  limit = 50
) {
  return db
    .select()
    .from(creditTransaction)
    .where(eq(creditTransaction.userId, userId))
    .orderBy(desc(creditTransaction.createdAt))
    .limit(limit);
}
```

**queries/index.ts:** If a queries index exists, add export. If not, create it:
```typescript
export * from './credit-transactions';
```

Verify the export is accessible from `@bragdoc/database`.
  </action>
  <verify>
    - `pnpm build --filter=@bragdoc/database` passes
    - Functions are exported from package
    - Types match schema enums (OperationType, FeatureType)
  </verify>
  <done>
    - insertCreditTransaction writes to CreditTransaction table
    - getCreditTransactionsByUser retrieves user's transaction history (for support)
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement credit checking utilities</name>
  <files>
    apps/web/lib/credits/check.ts
  </files>
  <action>
**check.ts:** Create credit checking functions:

```typescript
import type { User } from '@bragdoc/database/schema';

export interface CreditCheckResult {
  hasCredits: boolean;
  remainingCredits: number;
  isUnlimited: boolean;
}

export interface ChatMessageCheckResult {
  hasMessages: boolean;
  remainingMessages: number;
  isUnlimited: boolean;
}

/**
 * Check if user has sufficient credits for an operation.
 * Paid and demo users always have unlimited credits.
 */
export function checkUserCredits(
  user: User,
  requiredCredits: number
): CreditCheckResult {
  // Paid and demo users have unlimited credits
  if (user.level === 'paid' || user.level === 'demo') {
    return {
      hasCredits: true,
      remainingCredits: Infinity,
      isUnlimited: true,
    };
  }

  // Free users: check actual balance
  // Use nullish coalescing for existing users (NULL means never initialized = default 10)
  const credits = user.freeCredits ?? 10;

  return {
    hasCredits: credits >= requiredCredits,
    remainingCredits: credits,
    isUnlimited: false,
  };
}

/**
 * Check if user has remaining chat messages.
 * Paid and demo users always have unlimited messages.
 */
export function checkUserChatMessages(user: User): ChatMessageCheckResult {
  // Paid and demo users have unlimited messages
  if (user.level === 'paid' || user.level === 'demo') {
    return {
      hasMessages: true,
      remainingMessages: Infinity,
      isUnlimited: true,
    };
  }

  // Free users: check actual balance
  // Use nullish coalescing for existing users (NULL means never initialized = default 20)
  const messages = user.freeChatMessages ?? 20;

  return {
    hasMessages: messages > 0,
    remainingMessages: messages,
    isUnlimited: false,
  };
}
```

Key patterns:
- Use `user.freeCredits ?? 10` to handle NULL (existing users pre-migration)
- Always check user.level FIRST for paid/demo bypass
- Return structured objects for flexibility in UI display
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - Functions correctly handle paid/demo users (return unlimited)
    - Functions correctly handle NULL credits (default to 10/20)
  </verify>
  <done>
    - checkUserCredits returns accurate status for all user levels
    - checkUserChatMessages returns accurate message status
    - Both handle NULL values for existing users
  </done>
</task>

<task type="auto">
  <name>Task 3: Create credit transaction logger</name>
  <files>
    apps/web/lib/credits/logger.ts
    apps/web/lib/credits/index.ts
  </files>
  <action>
**logger.ts:** Create logging wrapper that writes to CreditTransaction table:

```typescript
import { insertCreditTransaction } from '@bragdoc/database/queries';
import type { OperationType, FeatureType } from '@bragdoc/database/schema';

export interface LogCreditTransactionInput {
  userId: string;
  amount: number;
  operation: OperationType;
  featureType: FeatureType;
  metadata?: {
    documentId?: string;
    documentType?: string;
    errorMessage?: string;
    refundReason?: string;
    [key: string]: unknown;
  };
}

/**
 * Log a credit transaction to the database for audit trail.
 *
 * IMPORTANT: Never include PII (email, name, password) in metadata.
 * Only include IDs and operation context.
 */
export async function logCreditTransaction(
  input: LogCreditTransactionInput
): Promise<void> {
  try {
    await insertCreditTransaction({
      userId: input.userId,
      amount: input.amount,
      operation: input.operation,
      featureType: input.featureType,
      metadata: input.metadata,
    });
  } catch (error) {
    // Log to console but don't fail the operation
    // Credit logging is secondary to the actual feature
    console.error('Failed to log credit transaction:', {
      userId: input.userId,
      operation: input.operation,
      featureType: input.featureType,
      error: error instanceof Error ? error.message : 'Unknown error',
    });
  }
}
```

**Update index.ts:** Add new exports:
```typescript
export { CREDIT_COSTS, getDocumentCost, type DocumentType } from './costs';
export { deductCredits, refundCredits, deductChatMessage, withCreditReservation } from './operations';
export { checkUserCredits, checkUserChatMessages, type CreditCheckResult, type ChatMessageCheckResult } from './check';
export { logCreditTransaction, type LogCreditTransactionInput } from './logger';
export { InsufficientCreditsError, InsufficientChatMessagesError } from './errors';
```

Note: Using console.error for logger failures rather than Pino (per research - keeping consistency with existing codebase logging patterns).
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - `pnpm build` succeeds
    - logCreditTransaction catches errors without failing operation
    - No PII fields in metadata type definition
  </verify>
  <done>
    - Credit transactions logged to database for audit trail
    - Logging failures are non-blocking (feature continues to work)
    - Metadata schema documents safe fields to include
  </done>
</task>

</tasks>

<verification>
After completing all tasks:

1. **Full Build:**
   ```bash
   pnpm build
   ```
   Must complete without errors for both database package and web app.

2. **Module Completeness Test:**
   ```typescript
   import {
     CREDIT_COSTS,
     deductCredits,
     checkUserCredits,
     logCreditTransaction,
     InsufficientCreditsError
   } from '@/lib/credits';
   ```
   All exports must be accessible.

3. **Pattern Verification:**
   - Grep for paid/demo bypass: `grep -r "level === 'paid'" apps/web/lib/credits/`
   - Grep for NULL handling: `grep -r "?? 10\|?? 20" apps/web/lib/credits/`
</verification>

<success_criteria>
- [ ] Credit transaction queries added to database package
- [ ] checkUserCredits handles free, paid, and demo users correctly
- [ ] checkUserChatMessages handles all user levels correctly
- [ ] logCreditTransaction writes to CreditTransaction table
- [ ] Logging failures don't block the main operation
- [ ] No PII in logged metadata
- [ ] All exports available from lib/credits/index.ts
- [ ] pnpm build succeeds for all packages
</success_criteria>

<output>
After completion, create `.planning/phases/02-credit-system/02-02-SUMMARY.md`
</output>

---
phase: 05-user-interface
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - apps/web/components/credit-status/chat-message-counter.tsx
  - apps/web/components/credit-status/credit-gated-button.tsx
  - apps/web/components/credit-status/index.ts
  - apps/web/components/performance-review/chat-interface.tsx
  - apps/web/app/(app)/account/page.tsx
  - apps/web/components/subscription/subscription-status.tsx
  - apps/web/app/(app)/upgrade/page.tsx
autonomous: true

must_haves:
  truths:
    - "Chat interface shows remaining message count for free users"
    - "Generate buttons are disabled with tooltip when credits insufficient"
    - "Account page displays subscription status (plan, renewal info)"
    - "Pricing comparison page shows annual vs lifetime options"
    - "402 API responses trigger upgrade modal"
  artifacts:
    - path: "apps/web/components/credit-status/chat-message-counter.tsx"
      provides: "Inline counter for chat interfaces"
      exports: ["ChatMessageCounter"]
    - path: "apps/web/components/credit-status/credit-gated-button.tsx"
      provides: "Button that disables with tooltip when credits insufficient"
      exports: ["CreditGatedButton"]
    - path: "apps/web/components/subscription/subscription-status.tsx"
      provides: "Account page subscription display"
      contains: "Lifetime Access"
    - path: "apps/web/app/(app)/upgrade/page.tsx"
      provides: "Pricing comparison page"
      contains: "$45/year"
  key_links:
    - from: "apps/web/components/performance-review/chat-interface.tsx"
      to: "ChatMessageCounter"
      via: "component import and render"
      pattern: "<ChatMessageCounter"
    - from: "apps/web/app/(app)/account/page.tsx"
      to: "SubscriptionStatus"
      via: "component import and render"
      pattern: "<SubscriptionStatus"
---

<objective>
Add chat message counter, credit-gated buttons, account subscription status, and pricing page

Purpose: Complete the user-facing credit/subscription UI by integrating counters into chat, adding disabled states for buttons, showing subscription info on account page, and creating a dedicated pricing comparison page.

Output: ChatMessageCounter component in chat UI, CreditGatedButton for generate actions, SubscriptionStatus on account page, and /upgrade pricing page.
</objective>

<execution_context>
@/Users/ed/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ed/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-user-interface/05-RESEARCH.md

# Depends on Plan 01 outputs
# CreditStatusProvider, useCreditStatus, UpgradeModal from apps/web/components/credit-status

# Key existing files
@apps/web/components/performance-review/chat-interface.tsx (chat component)
@apps/web/app/(app)/account/page.tsx (account settings page)
@apps/web/lib/stripe/subscription.ts (getSubscriptionStatus)
@apps/web/components/ui/tooltip.tsx (tooltip component)
@apps/web/components/ui/card.tsx (card component)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ChatMessageCounter and CreditGatedButton components</name>
  <files>
    apps/web/components/credit-status/chat-message-counter.tsx
    apps/web/components/credit-status/credit-gated-button.tsx
    apps/web/components/credit-status/index.ts
  </files>
  <action>
Create reusable components for chat message display and credit-gated buttons:

**ChatMessageCounter (apps/web/components/credit-status/chat-message-counter.tsx):**
- 'use client' directive
- Import useCreditStatus from current directory
- Import Badge from @/components/ui/badge

**Logic:**
1. Get status from useCreditStatus()
2. If !status || status.isUnlimited: return null (don't show for unlimited users)
3. Calculate remaining = status.freeChatMessages
4. Determine isLow = remaining <= 3

**Render:**
- Badge component with:
  - variant={isLow ? 'destructive' : 'secondary'}
  - className="text-xs"
  - Content: "{remaining}/20 messages"

**CreditGatedButton (apps/web/components/credit-status/credit-gated-button.tsx):**
- 'use client' directive
- Import Button and ButtonProps from @/components/ui/button
- Import Tooltip, TooltipTrigger, TooltipContent from @/components/ui/tooltip
- Import useCreditStatus from current directory

**Props interface (extends ButtonProps):**
- creditsRequired?: number (default 1)
- requiresChatMessage?: boolean (default false)
- children: React.ReactNode

**Logic:**
1. Get { status, showUpgradeModal } from useCreditStatus()
2. If status?.isUnlimited: render normal Button (pass through disabled prop and all other props)
3. Calculate:
   - hasSufficientCredits = !creditsRequired || (status?.freeCredits ?? 0) >= creditsRequired
   - hasSufficientMessages = !requiresChatMessage || (status?.freeChatMessages ?? 0) > 0
   - isBlocked = !hasSufficientCredits || !hasSufficientMessages

**Blocked state rendering:**
- Determine tooltipText:
  - If !hasSufficientCredits: `Requires ${creditsRequired} credit${creditsRequired > 1 ? 's' : ''}. Upgrade for unlimited access.`
  - Else: "No chat messages remaining. Upgrade for unlimited access."
- Wrap in Tooltip:
  - TooltipTrigger asChild with span wrapper (tabIndex={0} for accessibility)
  - Button inside span with disabled={true}, spread remaining props
  - onClick handler: e.preventDefault() then showUpgradeModal(!hasSufficientCredits ? 'credits' : 'messages')
  - TooltipContent with tooltipText

**Unblocked state:**
- Render normal Button with all props passed through

**Update index.ts:**
- Add exports for ChatMessageCounter and CreditGatedButton
  </action>
  <verify>
TypeScript compiles:
```bash
cd apps/web && npx tsc --noEmit
```
  </verify>
  <done>
ChatMessageCounter shows "X/20 messages" badge for free users (hidden for unlimited). CreditGatedButton wraps buttons with disabled state and tooltip when credits/messages insufficient.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate chat counter and handle 402 responses</name>
  <files>
    apps/web/components/performance-review/chat-interface.tsx
  </files>
  <action>
Add message counter to chat interface and handle insufficient credit errors:

**Modify chat-interface.tsx:**

**Imports:**
- Import ChatMessageCounter from @/components/credit-status
- Import useCreditStatus from @/components/credit-status

**In ChatInterface component:**
- Get { status, refresh, showUpgradeModal } from useCreditStatus()

**Add counter to header:**
In the CardHeader section, after the CardTitle "Refine with AI", add ChatMessageCounter:
```tsx
<div className="flex items-center justify-between">
  <div className="flex items-center gap-2">
    <CardTitle className="text-base">Refine with AI</CardTitle>
    <ChatMessageCounter />
  </div>
  <Button ... collapse button ... />
</div>
```

**Handle 402 in error display:**
The chat uses error prop from useChat hook. Modify the error handling section to detect 402:

Check if error message contains "402" or "credits" or "insufficient":
```tsx
{error && (
  <div className="mx-6 rounded-lg border border-destructive bg-destructive/10 p-3 text-sm text-destructive">
    {error.message?.includes('402') || error.message?.toLowerCase().includes('credit') ? (
      <div className="flex items-center justify-between">
        <span>You've run out of chat messages.</span>
        <button
          onClick={() => showUpgradeModal('messages')}
          className="text-primary underline"
        >
          Upgrade
        </button>
      </div>
    ) : (
      error.message || 'An error occurred. Please try again.'
    )}
  </div>
)}
```

**Refresh credits after message sent:**
The sendMessage function is passed as prop. We cannot directly hook into success.
Instead, add a useEffect that watches messages.length and calls refresh():
```tsx
const previousMessageCount = useRef(messages.length);

useEffect(() => {
  // If message count increased and last message is from assistant, refresh credits
  if (messages.length > previousMessageCount.current) {
    const lastMessage = messages[messages.length - 1];
    if (lastMessage?.role === 'user') {
      // User just sent a message - refresh after a short delay to let server process
      const timer = setTimeout(() => refresh(), 500);
      return () => clearTimeout(timer);
    }
  }
  previousMessageCount.current = messages.length;
}, [messages.length, refresh]);
```

Note: This is a best-effort refresh. The real enforcement is server-side.
  </action>
  <verify>
1. TypeScript compiles: `cd apps/web && npx tsc --noEmit`
2. Start dev server, navigate to performance review chat
3. Free user sees "X/20 messages" badge next to "Refine with AI" title
4. Paid/demo user does not see the counter
  </verify>
  <done>
Chat interface shows message counter for free users. 402 errors trigger upgrade prompt inline. Credits refresh after sending messages.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create subscription status component and pricing page</name>
  <files>
    apps/web/components/subscription/subscription-status.tsx
    apps/web/app/(app)/account/page.tsx
    apps/web/app/(app)/upgrade/page.tsx
  </files>
  <action>
Create subscription status display for account page and dedicated pricing page:

**SubscriptionStatus (apps/web/components/subscription/subscription-status.tsx):**
- 'use client' directive
- Import Card, CardHeader, CardTitle, CardContent, CardDescription from @/components/ui/card
- Import Badge from @/components/ui/badge
- Import Button from @/components/ui/button
- Import useCreditStatus from @/components/credit-status
- Import IconCrown, IconCalendar from @tabler/icons-react

**Render logic based on subscriptionType:**

Loading state:
- If isLoading || !status: return skeleton div with animate-pulse h-32 bg-muted rounded-lg

Lifetime:
```tsx
<Card>
  <CardHeader>
    <CardTitle>Subscription</CardTitle>
    <CardDescription>Your current plan</CardDescription>
  </CardHeader>
  <CardContent>
    <div className="flex items-center gap-3">
      <Badge className="bg-gradient-to-r from-yellow-400 to-yellow-600 text-white">
        <IconCrown className="size-3 mr-1" />
        Lifetime Access
      </Badge>
      <span className="text-sm text-muted-foreground">
        No renewal needed - you're set forever!
      </span>
    </div>
  </CardContent>
</Card>
```

Yearly:
```tsx
<Card>
  <CardHeader>...</CardHeader>
  <CardContent className="space-y-3">
    <div className="flex items-center gap-3">
      <Badge variant="secondary">Annual Plan</Badge>
      <span className="text-sm text-muted-foreground">
        <IconCalendar className="inline size-3 mr-1" />
        {status.daysRemaining} days until renewal
      </span>
    </div>
    <Button variant="outline" size="sm" asChild>
      <a href="/api/stripe/portal">Manage Subscription</a>
    </Button>
  </CardContent>
</Card>
```

Free:
```tsx
<Card>
  <CardHeader>...</CardHeader>
  <CardContent className="space-y-3">
    <div className="flex items-center gap-3">
      <Badge variant="outline">Free Plan</Badge>
    </div>
    <div className="text-sm text-muted-foreground">
      <p>{status.freeCredits} credits remaining</p>
      <p>{status.freeChatMessages} chat messages remaining</p>
    </div>
    <Button asChild>
      <a href="/upgrade">Upgrade to Unlimited</a>
    </Button>
  </CardContent>
</Card>
```

Demo:
```tsx
<Card>
  <CardHeader>...</CardHeader>
  <CardContent>
    <div className="flex items-center gap-3">
      <Badge variant="outline">Demo Mode</Badge>
      <span className="text-sm text-muted-foreground">
        Full access for demonstration
      </span>
    </div>
  </CardContent>
</Card>
```

**Modify account/page.tsx:**
- Import SubscriptionStatus from @/components/subscription/subscription-status
- Add Subscription section after Export section, before Import section:
```tsx
{/* Subscription Section */}
<SubscriptionStatus />

{/* Divider */}
<div className="border-border border-t" />
```

**Create upgrade/page.tsx:**
New pricing comparison page at apps/web/app/(app)/upgrade/page.tsx:

- Import AppPage from components/shared/app-page
- Import SidebarInset from @/components/ui/sidebar
- Import SiteHeader from @/components/site-header
- Import Card, CardHeader, CardTitle, CardContent, CardDescription from @/components/ui/card
- Import Button from @/components/ui/button
- Import Badge from @/components/ui/badge
- Import IconCheck, IconCrown from @tabler/icons-react

Page structure:
```tsx
export default function UpgradePage() {
  return (
    <AppPage
      title="Upgrade"
      description="Choose your plan for unlimited access"
    >
      <SidebarInset>
        <SiteHeader title="Upgrade to Unlimited" />
        <div className="p-6">
          {/* Intro */}
          <div className="mb-8 text-center">
            <h2 className="text-2xl font-bold">Unlock Unlimited AI Power</h2>
            <p className="text-muted-foreground mt-2">
              Generate unlimited documents and chat without limits
            </p>
          </div>

          {/* Pricing cards */}
          <div className="mx-auto max-w-2xl grid gap-6 sm:grid-cols-2">
            {/* Annual Card */}
            <Card>
              <CardHeader>
                <CardTitle>Annual</CardTitle>
                <CardDescription>Billed yearly</CardDescription>
              </CardHeader>
              <CardContent className="space-y-4">
                <div>
                  <span className="text-4xl font-bold">$45</span>
                  <span className="text-muted-foreground">/year</span>
                </div>
                <p className="text-sm text-muted-foreground">
                  Just $3.75/month, billed annually
                </p>
                <ul className="space-y-2 text-sm">
                  <li className="flex items-center gap-2">
                    <IconCheck className="size-4 text-green-600" />
                    Unlimited document generation
                  </li>
                  <li className="flex items-center gap-2">
                    <IconCheck className="size-4 text-green-600" />
                    Unlimited chat messages
                  </li>
                  <li className="flex items-center gap-2">
                    <IconCheck className="size-4 text-green-600" />
                    Cancel anytime
                  </li>
                </ul>
                <Button className="w-full" asChild>
                  <a href={process.env.NEXT_PUBLIC_STRIPE_YEARLY_LINK || '#'}>
                    Get Annual Plan
                  </a>
                </Button>
              </CardContent>
            </Card>

            {/* Lifetime Card */}
            <Card className="relative border-primary">
              <div className="absolute -top-3 left-1/2 -translate-x-1/2">
                <Badge className="bg-primary">Best Value</Badge>
              </div>
              <CardHeader>
                <CardTitle className="flex items-center gap-2">
                  <IconCrown className="size-4 text-yellow-500" />
                  Lifetime
                </CardTitle>
                <CardDescription>One-time payment</CardDescription>
              </CardHeader>
              <CardContent className="space-y-4">
                <div>
                  <span className="text-4xl font-bold">$99</span>
                  <span className="text-muted-foreground"> once</span>
                </div>
                <p className="text-sm text-muted-foreground">
                  Pay once, use forever
                </p>
                <ul className="space-y-2 text-sm">
                  <li className="flex items-center gap-2">
                    <IconCheck className="size-4 text-green-600" />
                    Unlimited forever
                  </li>
                  <li className="flex items-center gap-2">
                    <IconCheck className="size-4 text-green-600" />
                    No recurring payments
                  </li>
                  <li className="flex items-center gap-2">
                    <IconCheck className="size-4 text-green-600" />
                    = 2.2 years of annual
                  </li>
                </ul>
                <Button className="w-full" asChild>
                  <a href={process.env.NEXT_PUBLIC_STRIPE_LIFETIME_LINK || '#'}>
                    Get Lifetime Access
                  </a>
                </Button>
              </CardContent>
            </Card>
          </div>

          {/* FAQ or trust signals */}
          <div className="mt-8 text-center text-sm text-muted-foreground">
            <p>Secure payment via Stripe. Cancel your annual plan anytime.</p>
          </div>
        </div>
      </SidebarInset>
    </AppPage>
  );
}
```

**Note:** The NEXT_PUBLIC_STRIPE_YEARLY_LINK and NEXT_PUBLIC_STRIPE_LIFETIME_LINK env vars were documented in Phase 3. The page will use '#' fallback if not set.
  </action>
  <verify>
1. TypeScript compiles: `cd apps/web && npx tsc --noEmit`
2. Build succeeds: `pnpm build:web`
3. Navigate to /account - subscription section appears
4. Navigate to /upgrade - pricing comparison page renders
  </verify>
  <done>
Account page shows subscription status (plan type, renewal date for yearly, credits for free). Pricing page at /upgrade displays annual ($45/year) vs lifetime ($99) comparison with clear CTAs.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Chat message counter (UI-02):**
   - Navigate to performance review with AI refinement
   - Free user: "X/20 messages" badge visible next to "Refine with AI"
   - Paid/demo user: no badge visible
   - Counter updates after sending messages (with slight delay)

2. **Credit-gated button (UI-05):**
   - CreditGatedButton component exported and available
   - When wrapped around generate buttons:
     - Free user with 0 credits: button disabled, tooltip shows upgrade message
     - Free user with credits: button enabled normally
     - Paid/demo user: button always enabled

3. **Account subscription status (UI-06):**
   - Navigate to /account
   - Free user: shows "Free Plan" badge, credits remaining, upgrade button
   - Yearly user: shows "Annual Plan" badge, days until renewal, manage link
   - Lifetime user: shows "Lifetime Access" badge with crown icon
   - Demo user: shows "Demo Mode" badge

4. **Pricing comparison page (UI-07):**
   - Navigate to /upgrade
   - Annual card: $45/year, $3.75/month, benefits list, CTA button
   - Lifetime card: $99 once, "Best Value" badge, benefits list, CTA button
   - Both cards have clear pricing and no dark patterns

5. **402 handling (UI-03, UI-04):**
   - When chat receives 402 error, inline upgrade prompt appears
   - Clicking upgrade in error message opens upgrade modal

6. **Build verification:**
   ```bash
   pnpm build:web
   ```
</verification>

<success_criteria>
- Chat shows "X/20 messages" for free users, hidden for unlimited
- CreditGatedButton disables with tooltip when credits insufficient
- Account page displays current plan with appropriate details per tier
- /upgrade page shows annual vs lifetime comparison
- 402 errors show upgrade prompt
- All requirements UI-01 through UI-07 covered
- TypeScript compiles, build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/05-user-interface/05-02-SUMMARY.md`
</output>

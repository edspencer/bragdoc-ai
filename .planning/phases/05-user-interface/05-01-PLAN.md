---
phase: 05-user-interface
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/web/components/credit-status/credit-status-provider.tsx
  - apps/web/components/credit-status/credit-status-display.tsx
  - apps/web/components/credit-status/upgrade-modal.tsx
  - apps/web/components/credit-status/index.ts
  - apps/web/hooks/use-credit-status.ts
  - apps/web/app/api/user/credit-status/route.ts
  - apps/web/components/app-sidebar.tsx
  - apps/web/app/(app)/layout.tsx
autonomous: true

must_haves:
  truths:
    - "Free users see their remaining credits in the sidebar"
    - "Free users see their remaining chat messages in the sidebar"
    - "Paid/demo users see 'Unlimited Access' badge instead of counters"
    - "Upgrade modal appears with annual and lifetime options"
    - "Modal can be easily dismissed without purchasing"
  artifacts:
    - path: "apps/web/components/credit-status/credit-status-provider.tsx"
      provides: "React context for credit/message status"
      exports: ["CreditStatusProvider", "useCreditStatus"]
    - path: "apps/web/components/credit-status/upgrade-modal.tsx"
      provides: "Upgrade dialog with pricing options"
      contains: "$45/year"
    - path: "apps/web/app/api/user/credit-status/route.ts"
      provides: "API endpoint for credit status"
      exports: ["GET"]
  key_links:
    - from: "apps/web/app/(app)/layout.tsx"
      to: "CreditStatusProvider"
      via: "provider wrapping app layout"
      pattern: "<CreditStatusProvider"
    - from: "apps/web/components/app-sidebar.tsx"
      to: "CreditStatusDisplay"
      via: "sidebar footer integration"
      pattern: "CreditStatusDisplay"
    - from: "apps/web/components/credit-status/credit-status-provider.tsx"
      to: "/api/user/credit-status"
      via: "fetch on refresh"
      pattern: "fetch.*api/user/credit-status"
---

<objective>
Create credit status context provider, API endpoint, sidebar display, and upgrade modal

Purpose: Establish the foundation for displaying credit/message status throughout the app and prompting upgrades when limits are reached.

Output: CreditStatusProvider context with useCreditStatus hook, credit status API endpoint, sidebar credit display, and upgrade modal dialog.
</objective>

<execution_context>
@/Users/ed/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ed/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-user-interface/05-RESEARCH.md

# Key existing files
@apps/web/components/demo-mode-provider.tsx (context provider pattern)
@apps/web/components/app-sidebar.tsx (sidebar structure)
@apps/web/app/(app)/layout.tsx (provider nesting)
@apps/web/lib/stripe/subscription.ts (getSubscriptionStatus helper)
@apps/web/lib/credits/check.ts (checkUserCredits, checkUserChatMessages)
@apps/web/components/ui/dialog.tsx (dialog component)
@apps/web/components/ui/progress.tsx (progress bar)
@apps/web/components/ui/badge.tsx (badge component)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create credit status API endpoint and context provider</name>
  <files>
    apps/web/app/api/user/credit-status/route.ts
    apps/web/components/credit-status/credit-status-provider.tsx
    apps/web/components/credit-status/index.ts
    apps/web/hooks/use-credit-status.ts
  </files>
  <action>
Create the API endpoint and React context infrastructure for credit status:

**API Endpoint (apps/web/app/api/user/credit-status/route.ts):**
- GET handler with authentication via getAuthUser
- Fetch fresh user data from database using getUserById from @bragdoc/database
- Call getSubscriptionStatus from lib/stripe/subscription.ts
- Return JSON with: freeCredits (number), freeChatMessages (number), isUnlimited (boolean), subscriptionType ('free' | 'yearly' | 'lifetime' | 'demo'), daysRemaining (number | undefined)
- For credits/messages, use nullish coalescing: `user.freeCredits ?? 10` and `user.freeChatMessages ?? 20`
- Return 401 for unauthenticated, 404 if user not found

**Context Provider (apps/web/components/credit-status/credit-status-provider.tsx):**
Follow the pattern from demo-mode-provider.tsx:
- 'use client' directive
- CreditStatus interface: freeCredits, freeChatMessages, isUnlimited, subscriptionType, daysRemaining
- CreditStatusContextValue interface: status (CreditStatus | null), isLoading (boolean), refresh() (async), showUpgradeModal(reason: 'credits' | 'messages')
- CreditStatusProvider component:
  - Props: children, initialStatus (optional CreditStatus for SSR hydration)
  - State: status, isLoading, upgradeModalOpen, upgradeReason
  - refresh callback: fetch /api/user/credit-status and update state
  - showUpgradeModal callback: set upgradeReason and open modal
  - useEffect to fetch on mount if no initialStatus
  - Render children wrapped with context provider
  - Include UpgradeModal component (import from ./upgrade-modal)
- Export useCreditStatus hook that throws if used outside provider

**Index file (apps/web/components/credit-status/index.ts):**
- Export CreditStatusProvider, useCreditStatus from provider
- Export UpgradeModal from upgrade-modal (created in Task 2)
- Export CreditStatusDisplay from credit-status-display (created in Task 3)

**Hook alias (apps/web/hooks/use-credit-status.ts):**
- Re-export useCreditStatus from @/components/credit-status for convenience
  </action>
  <verify>
TypeScript compiles without errors:
```bash
cd apps/web && npx tsc --noEmit
```
  </verify>
  <done>
API endpoint returns credit status JSON. Context provider manages status state with refresh and modal triggers. Hook exported for consumer components.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create upgrade modal dialog</name>
  <files>
    apps/web/components/credit-status/upgrade-modal.tsx
  </files>
  <action>
Create the upgrade modal dialog component:

**UpgradeModal (apps/web/components/credit-status/upgrade-modal.tsx):**
- 'use client' directive
- Props: open (boolean), onOpenChange ((open: boolean) => void), reason ('credits' | 'messages')
- Use Dialog, DialogContent, DialogHeader, DialogTitle, DialogDescription from @/components/ui/dialog
- Use Card, CardHeader, CardTitle, CardContent, CardDescription from @/components/ui/card
- Use Button from @/components/ui/button
- Use Badge from @/components/ui/badge
- Icons from @tabler/icons-react: IconCheck, IconSparkles

**Title/description based on reason:**
- credits: "You've used all your free credits" / "You've used all 10 free credits. Upgrade for unlimited document generation."
- messages: "You've used all your free chat messages" / "You've used all 20 free messages. Upgrade for unlimited chat conversations."

**Layout:**
- DialogContent with sm:max-w-xl
- Header with IconSparkles and dynamic title/description
- Grid of 2 cards (sm:grid-cols-2):

**Annual Card:**
- CardTitle: "Annual"
- CardDescription: "Billed yearly"
- Price: "$45" with "/year" suffix in muted text
- Benefits list (IconCheck for each):
  - Unlimited credits
  - Unlimited chat messages
  - Cancel anytime
- Button linking to process.env.NEXT_PUBLIC_STRIPE_YEARLY_LINK or fallback '/upgrade'
- Use `asChild` with anchor tag for external link

**Lifetime Card:**
- Add "Best Value" Badge positioned absolute -top-3 centered
- Border with border-primary class
- CardTitle: "Lifetime"
- CardDescription: "One-time payment"
- Price: "$99" with " once" suffix
- Benefits list:
  - Unlimited forever
  - No recurring payments
  - = 2.2 years of annual
- Button linking to process.env.NEXT_PUBLIC_STRIPE_LIFETIME_LINK or fallback '/upgrade'

**Footer:**
- Centered muted text: "Secure payment via Stripe. You can dismiss this and continue with limited access."

**No dark patterns:**
- Dialog allows close via X button and clicking outside
- No fake urgency, no countdown timers
- Clear easy dismissal
  </action>
  <verify>
TypeScript compiles:
```bash
cd apps/web && npx tsc --noEmit
```
Manually verify by importing and rendering modal in a test page.
  </verify>
  <done>
UpgradeModal displays annual ($45/year) and lifetime ($99) options with clear pricing, benefits, and easy dismissal.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create sidebar credit display and integrate with layout</name>
  <files>
    apps/web/components/credit-status/credit-status-display.tsx
    apps/web/components/app-sidebar.tsx
    apps/web/app/(app)/layout.tsx
  </files>
  <action>
Create the sidebar credit display and integrate the provider:

**CreditStatusDisplay (apps/web/components/credit-status/credit-status-display.tsx):**
- 'use client' directive
- Use useCreditStatus hook
- Use Progress from @/components/ui/progress
- Use Badge from @/components/ui/badge
- Use SidebarGroup, SidebarGroupContent from @/components/ui/sidebar

**Rendering logic:**
1. If isLoading: return null (don't show loading skeleton in sidebar)
2. If status?.isUnlimited: show Badge with "Unlimited Access" centered
3. Otherwise show credit/message counters:

**Counter display for free users:**
- Wrap in SidebarGroup
- SidebarGroupContent with className="space-y-3 px-2"
- Credits section:
  - Flex row with "Credits" label and "{status.freeCredits}/10" value
  - Progress bar with value={(status.freeCredits / 10) * 100}, className="h-1.5"
- Messages section (same pattern):
  - "Chat Messages" label and "{status.freeChatMessages}/20" value
  - Progress bar with value={(status.freeChatMessages / 20) * 100}
- If low (credits <= 2 OR messages <= 3):
  - Show link/button: "Upgrade for unlimited" that calls showUpgradeModal('credits')
  - Use text-xs text-primary hover:underline styling

**Modify app-sidebar.tsx:**
- Import CreditStatusDisplay from @/components/credit-status
- In SidebarFooter, add CreditStatusDisplay ABOVE NavUser component

**Modify layout.tsx:**
- Import CreditStatusProvider from @/components/credit-status
- Import getUserById from @bragdoc/database
- After getting session, fetch user data if authenticated:
  ```typescript
  const user = session?.user?.id
    ? await getUserById(session.user.id)
    : undefined;
  ```
- Derive initial status from user for SSR hydration:
  ```typescript
  const initialCreditStatus = user ? {
    freeCredits: user.freeCredits ?? 10,
    freeChatMessages: user.freeChatMessages ?? 20,
    isUnlimited: user.level === 'paid' || user.level === 'demo',
    subscriptionType: deriveSubscriptionType(user), // helper function
    daysRemaining: undefined, // simplified for initial load
  } : undefined;
  ```
- Wrap existing providers with CreditStatusProvider, passing initialStatus
- Place CreditStatusProvider INSIDE DemoModeProvider but OUTSIDE SidebarProvider
  </action>
  <verify>
1. TypeScript compiles: `cd apps/web && npx tsc --noEmit`
2. Dev server runs without errors: `pnpm dev:web`
3. Navigate to dashboard - sidebar shows credit status for free users or "Unlimited Access" for paid/demo
  </verify>
  <done>
Sidebar displays credit/message counters for free users with progress bars. Paid/demo users see "Unlimited Access" badge. Low credit state shows upgrade link. CreditStatusProvider wraps app layout for global access.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **API endpoint works:**
   ```bash
   curl -X GET http://localhost:3000/api/user/credit-status \
     -H "Cookie: [auth-cookie]"
   ```
   Should return JSON with freeCredits, freeChatMessages, isUnlimited, subscriptionType

2. **Free user sidebar display:**
   - Log in as free user
   - Sidebar footer shows "Credits X/10" with progress bar
   - Sidebar footer shows "Chat Messages X/20" with progress bar
   - If either is low, "Upgrade for unlimited" link appears

3. **Paid/demo user sidebar display:**
   - Log in as paid or demo user
   - Sidebar footer shows "Unlimited Access" badge
   - No credit counters visible

4. **Upgrade modal:**
   - Click "Upgrade for unlimited" link when low on credits
   - Modal opens with annual ($45/year) and lifetime ($99) options
   - Modal can be closed via X button or clicking outside
   - Payment links point to Stripe (or /upgrade fallback)

5. **Build passes:**
   ```bash
   pnpm build:web
   ```
</verification>

<success_criteria>
- Free users see credit balance (X/10) and message count (X/20) in sidebar
- Progress bars visualize remaining allowance
- Paid/demo users see "Unlimited Access" badge
- Upgrade modal shows $45/year and $99 lifetime options
- Modal is easily dismissible (no dark patterns)
- Context provider enables status access throughout app
- API endpoint returns fresh credit status
- TypeScript compiles, build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/05-user-interface/05-01-SUMMARY.md`
</output>

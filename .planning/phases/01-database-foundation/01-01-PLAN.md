---
phase: 01-database-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/database/src/schema.ts
autonomous: true

must_haves:
  truths:
    - "New free users receive freeCredits=10 upon account creation"
    - "New free users receive freeChatMessages=20 upon account creation"
    - "User level can be set to 'free', 'paid', or 'demo'"
    - "Renewal period can be set to 'yearly' or 'lifetime'"
    - "Database prevents negative freeCredits via CHECK constraint"
    - "Database prevents negative freeChatMessages via CHECK constraint"
  artifacts:
    - path: "packages/database/src/schema.ts"
      provides: "Updated user table with credit fields and updated enums"
      contains: "freeCredits"
    - path: "packages/database/drizzle"
      provides: "Generated migration file"
      min_files: 1
  key_links:
    - from: "packages/database/src/schema.ts"
      to: "packages/database/drizzle/*.sql"
      via: "pnpm db:generate"
      pattern: "free_credits"
---

<objective>
Add credit and chat message tracking fields to the User table, update subscription enums, and add CHECK constraints to prevent negative balances.

Purpose: Establish the data model foundation for the simplified pricing system where free users get 10 LLM credits and 20 chat messages.

Output: Updated schema.ts with new fields and constraints, generated migration file ready for deployment.
</objective>

<execution_context>
@/Users/ed/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ed/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-database-foundation/01-RESEARCH.md

@packages/database/src/schema.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update enums and add credit fields to User table</name>
  <files>packages/database/src/schema.ts</files>
  <action>
Update the schema.ts file with the following changes:

1. **Update userLevelEnum** (lines 38-43):
   Change from `['free', 'basic', 'pro', 'demo']` to `['free', 'basic', 'pro', 'paid', 'demo']`.
   Add 'paid' to the array - keep 'basic' and 'pro' for PostgreSQL compatibility (cannot remove enum values).
   Add comment: `// 'basic' and 'pro' are deprecated but kept for PostgreSQL enum compatibility`

2. **Update renewalPeriodEnum** (lines 46-49):
   Change from `['monthly', 'yearly']` to `['monthly', 'yearly', 'lifetime']`.
   Add 'lifetime' to the array - keep 'monthly' for PostgreSQL compatibility.
   Add comment: `// 'monthly' is deprecated but kept for PostgreSQL enum compatibility`

3. **Add credit fields to user table** (after line 100, inside the user table definition):
   Add two new integer fields:
   ```typescript
   // Credit system fields (new users get free trial credits)
   freeCredits: integer('free_credits').default(10),
   freeChatMessages: integer('free_chat_messages').default(20),
   ```

4. **Add CHECK constraints** to the user table's third parameter (the constraint object starting at line 106):
   Import `check` from 'drizzle-orm/pg-core' at the top of the file.
   Add two check constraints to the existing constraint object:
   ```typescript
   // Credit balance constraints
   freeCreditsNonNegative: check('free_credits_non_negative',
     sql`${table.freeCredits} IS NULL OR ${table.freeCredits} >= 0`),
   freeChatMessagesNonNegative: check('free_chat_messages_non_negative',
     sql`${table.freeChatMessages} IS NULL OR ${table.freeChatMessages} >= 0`),
   ```

Note: The CHECK constraint allows NULL (for existing users pre-migration) OR >= 0. This prevents negative balances while allowing the migration to work with existing data.
  </action>
  <verify>
Run TypeScript compilation to verify no type errors:
```bash
cd /Users/ed/Code/brag-ai && pnpm tsc --noEmit -p packages/database/tsconfig.json
```
  </verify>
  <done>
Schema updated with:
- userLevelEnum includes 'paid' (while keeping deprecated 'basic'/'pro')
- renewalPeriodEnum includes 'lifetime' (while keeping deprecated 'monthly')
- User table has freeCredits (default 10) and freeChatMessages (default 20) fields
- CHECK constraints prevent negative credit balances
  </done>
</task>

<task type="auto">
  <name>Task 2: Generate and verify migration file</name>
  <files>packages/database/drizzle</files>
  <action>
Generate the database migration using Drizzle Kit:

1. Run migration generation:
   ```bash
   cd /Users/ed/Code/brag-ai && pnpm db:generate
   ```

2. Review the generated migration file in `packages/database/drizzle/` directory.
   The migration should contain:
   - `ALTER TYPE "user_level" ADD VALUE 'paid'` (may need statement breakpoint)
   - `ALTER TYPE "renewal_period" ADD VALUE 'lifetime'` (may need statement breakpoint)
   - `ALTER TABLE "User" ADD COLUMN "free_credits" integer DEFAULT 10`
   - `ALTER TABLE "User" ADD COLUMN "free_chat_messages" integer DEFAULT 20`
   - `ALTER TABLE "User" ADD CONSTRAINT "free_credits_non_negative" CHECK (...)`
   - `ALTER TABLE "User" ADD CONSTRAINT "free_chat_messages_non_negative" CHECK (...)`

3. If the migration includes `ALTER TYPE ADD VALUE` statements, ensure they have `--> statement-breakpoint` before them. PostgreSQL requires new enum values to be committed before they can be used.

4. Verify the migration SQL is valid by checking there are no syntax errors in the generated file.
  </action>
  <verify>
```bash
# List generated migration files
ls -la /Users/ed/Code/brag-ai/packages/database/drizzle/

# Show the latest migration content
cat /Users/ed/Code/brag-ai/packages/database/drizzle/*.sql | tail -100
```
  </verify>
  <done>
Migration file generated in packages/database/drizzle/ containing:
- Enum value additions for 'paid' and 'lifetime'
- New credit fields with defaults
- CHECK constraints for non-negative balances
  </done>
</task>

</tasks>

<verification>
All verification checks:

1. **TypeScript compiles:** `pnpm tsc --noEmit -p packages/database/tsconfig.json` passes
2. **Migration generated:** New .sql file exists in packages/database/drizzle/
3. **Schema exports updated types:** UserLevel type includes 'paid', RenewalPeriod includes 'lifetime'
4. **Build passes:** `pnpm build --filter=@bragdoc/database` succeeds
</verification>

<success_criteria>
Phase 1 Plan 01 is complete when:

1. schema.ts contains freeCredits and freeChatMessages fields with defaults
2. userLevelEnum includes 'paid' value
3. renewalPeriodEnum includes 'lifetime' value
4. CHECK constraints exist for both credit fields
5. Migration file is generated and contains all required DDL statements
6. TypeScript compilation passes
7. Database package builds successfully
</success_criteria>

<output>
After completion, create `.planning/phases/01-database-foundation/01-01-SUMMARY.md`
</output>

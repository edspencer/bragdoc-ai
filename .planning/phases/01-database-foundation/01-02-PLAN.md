---
phase: 01-database-foundation
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - packages/database/src/schema.ts
  - packages/database/drizzle
autonomous: true

must_haves:
  truths:
    - "Credit transactions can be logged with user, amount, operation, and feature type"
    - "Credit transaction history can be queried by userId efficiently"
    - "Credit transaction history can be queried by timestamp efficiently"
  artifacts:
    - path: "packages/database/src/schema.ts"
      provides: "CreditTransaction table definition with enums and indexes"
      contains: "creditTransaction"
    - path: "packages/database/drizzle"
      provides: "Migration file for audit table"
      min_files: 1
  key_links:
    - from: "creditTransaction.userId"
      to: "user.id"
      via: "foreign key reference"
      pattern: "references.*user.id"
---

<objective>
Create the credit_transactions audit table for logging all credit operations, enabling debugging and customer support.

Purpose: Provide an audit trail for credit usage that supports debugging, customer support inquiries, and potential refund scenarios.

Output: CreditTransaction table with operation and feature type enums, proper indexes, and generated migration file.
</objective>

<execution_context>
@/Users/ed/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ed/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-database-foundation/01-RESEARCH.md
@.planning/phases/01-database-foundation/01-01-SUMMARY.md

@packages/database/src/schema.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create audit table enums and CreditTransaction table</name>
  <files>packages/database/src/schema.ts</files>
  <action>
Add the credit transaction audit table to schema.ts. Add this after the emailPreferences table (at the end of the file, before the closing).

1. **Add operation type enum** (after the existing enums, around line 67):
   ```typescript
   // Credit transaction audit enums
   export const operationTypeEnum = pgEnum('operation_type', ['deduct', 'refund', 'grant']);
   export type OperationType = (typeof operationTypeEnum.enumValues)[number];
   ```

2. **Add feature type enum** (immediately after):
   ```typescript
   export const featureTypeEnum = pgEnum('feature_type', [
     'document_generation',      // Brag docs, performance reviews, weekly reports
     'workstream_clustering',    // ML-powered workstream generation
     'chat_tool_call',          // Tool calls within chat (update document, etc.)
     'chat_message',            // Chat message from free user
   ]);
   export type FeatureType = (typeof featureTypeEnum.enumValues)[number];
   ```

3. **Add CreditTransaction table** (at the end of the file, before the final exports):
   ```typescript
   // Credit transaction audit table for debugging and support
   export const creditTransaction = pgTable(
     'CreditTransaction',
     {
       id: uuid('id').primaryKey().notNull().defaultRandom(),
       userId: uuid('user_id')
         .notNull()
         .references(() => user.id, { onDelete: 'cascade' }),
       amount: integer('amount').notNull(), // Positive for deduct/grant, shows magnitude
       operation: operationTypeEnum('operation').notNull(),
       featureType: featureTypeEnum('feature_type').notNull(),
       metadata: jsonb('metadata').$type<Record<string, unknown>>(),
       createdAt: timestamp('created_at').notNull().defaultNow(),
     },
     (table) => ({
       // Index for user-specific queries (support lookups)
       userIdIdx: index('credit_tx_user_id_idx').on(table.userId),
       // Index for time-based queries (analytics)
       createdAtIdx: index('credit_tx_created_at_idx').on(table.createdAt),
       // Composite index for common query: user's recent transactions
       userCreatedAtIdx: index('credit_tx_user_created_at_idx').on(
         table.userId,
         table.createdAt,
       ),
     }),
   );

   export type CreditTransaction = InferSelectModel<typeof creditTransaction>;
   ```

Note: The metadata field uses `Record<string, unknown>` for type safety. It can store additional context like document IDs, error messages, or refund reasons.
  </action>
  <verify>
Run TypeScript compilation to verify no type errors:
```bash
cd /Users/ed/Code/brag-ai && pnpm tsc --noEmit -p packages/database/tsconfig.json
```
  </verify>
  <done>
Schema updated with:
- operationTypeEnum with 'deduct', 'refund', 'grant' values
- featureTypeEnum with document_generation, workstream_clustering, chat_tool_call, chat_message values
- CreditTransaction table with userId FK, amount, operation, featureType, metadata, createdAt
- Three indexes for efficient querying
  </done>
</task>

<task type="auto">
  <name>Task 2: Generate migration and verify complete schema</name>
  <files>packages/database/drizzle</files>
  <action>
Generate the database migration for the audit table:

1. Run migration generation:
   ```bash
   cd /Users/ed/Code/brag-ai && pnpm db:generate
   ```

2. Review the generated migration file. It should contain:
   - `CREATE TYPE "operation_type" AS ENUM ('deduct', 'refund', 'grant')`
   - `CREATE TYPE "feature_type" AS ENUM (...)`
   - `CREATE TABLE "CreditTransaction" (...)`
   - `CREATE INDEX "credit_tx_user_id_idx" ...`
   - `CREATE INDEX "credit_tx_created_at_idx" ...`
   - `CREATE INDEX "credit_tx_user_created_at_idx" ...`

3. Run the full database package build to ensure everything compiles:
   ```bash
   cd /Users/ed/Code/brag-ai && pnpm build --filter=@bragdoc/database
   ```
  </action>
  <verify>
```bash
# List all migration files
ls -la /Users/ed/Code/brag-ai/packages/database/drizzle/

# Verify the latest migration contains CreditTransaction
grep -l "CreditTransaction" /Users/ed/Code/brag-ai/packages/database/drizzle/*.sql

# Build the database package
cd /Users/ed/Code/brag-ai && pnpm build --filter=@bragdoc/database
```
  </verify>
  <done>
Migration file generated containing:
- New enum type definitions (operation_type, feature_type)
- CreditTransaction table creation
- All three indexes
Database package builds successfully
  </done>
</task>

</tasks>

<verification>
All verification checks:

1. **TypeScript compiles:** `pnpm tsc --noEmit -p packages/database/tsconfig.json` passes
2. **Migration generated:** New .sql file in packages/database/drizzle/ with CreditTransaction table
3. **Types exported:** CreditTransaction, OperationType, FeatureType types are exported
4. **Build passes:** `pnpm build --filter=@bragdoc/database` succeeds
5. **Indexes created:** Migration includes all three index definitions
</verification>

<success_criteria>
Phase 1 Plan 02 is complete when:

1. schema.ts contains operationTypeEnum and featureTypeEnum definitions
2. schema.ts contains CreditTransaction table with all required fields
3. CreditTransaction has foreign key to User with cascade delete
4. Three indexes defined (userId, createdAt, userId+createdAt composite)
5. Migration file is generated with CREATE TABLE and CREATE INDEX statements
6. TypeScript compilation passes
7. Database package builds successfully
8. Types CreditTransaction, OperationType, FeatureType are exported
</success_criteria>

<output>
After completion, create `.planning/phases/01-database-foundation/01-02-SUMMARY.md`
</output>

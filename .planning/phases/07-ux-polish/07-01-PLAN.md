---
phase: 07-ux-polish
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/web/components/generate-document-dialog.tsx
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "When document generation returns 402, upgrade modal appears"
    - "User sees pricing options (yearly $45, lifetime $99) in the modal"
    - "User can dismiss modal and return to document dialog"
  artifacts:
    - path: "apps/web/components/generate-document-dialog.tsx"
      provides: "402 error handling with upgrade modal"
      contains: "showUpgradeModal"
  key_links:
    - from: "apps/web/components/generate-document-dialog.tsx"
      to: "CreditStatusProvider context"
      via: "useCreditStatus hook"
      pattern: "useCreditStatus.*showUpgradeModal"
---

<objective>
Add 402 status code handling to generate-document-dialog.tsx that shows the upgrade modal instead of a generic toast error.

Purpose: Free users who exhaust their 10 credits and attempt document generation should see the upgrade modal with pricing options, not a generic error toast. This matches the behavior already implemented in chat-interface.tsx.

Output: Updated generate-document-dialog.tsx with proper 402 handling
</objective>

<execution_context>
@/Users/ed/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ed/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

Reference pattern (already implemented):
@apps/web/components/performance-review/chat-interface.tsx (lines 59-60, 189-200)

Target file to modify:
@apps/web/components/generate-document-dialog.tsx (lines 198-216 error handling)

Credit status hook:
@apps/web/components/credit-status/credit-status-provider.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add 402 handling with upgrade modal</name>
  <files>apps/web/components/generate-document-dialog.tsx</files>
  <action>
    1. Add import for useCreditStatus hook:
       ```typescript
       import { useCreditStatus } from '@/components/credit-status';
       ```
       Add this after the existing imports (around line 19, after the types import).

    2. Inside the GenerateDocumentDialog component (after line 139 `const router = useRouter();`), add:
       ```typescript
       const { showUpgradeModal } = useCreditStatus();
       ```

    3. In the error handling block (lines 198-216), add a case for 402 status BEFORE the generic fallback.
       After line 213 (`throw new Error(...);` for 400 case) and before the else block, add:
       ```typescript
       } else if (response.status === 402) {
         // Credit exhausted - show upgrade modal instead of toast
         showUpgradeModal('credits');
         setIsGenerating(false);
         return; // Exit early, no toast needed
       ```

    Pattern Reference: See chat-interface.tsx lines 189-200 for similar implementation.
    The key difference is this is in a try/catch block for fetch, so we return early rather than throwing.
  </action>
  <verify>
    1. TypeScript compiles without errors:
       ```bash
       cd apps/web && pnpm tsc --noEmit
       ```
    2. Lint passes:
       ```bash
       pnpm lint apps/web/components/generate-document-dialog.tsx
       ```
    3. Manual verification steps:
       - Free user with 0 credits attempts document generation
       - 402 response triggers upgrade modal (not toast)
       - Modal shows yearly ($45) and lifetime ($99) options
       - Dismissing modal returns to document dialog
  </verify>
  <done>
    - generate-document-dialog.tsx imports useCreditStatus
    - Component calls showUpgradeModal('credits') on 402
    - No toast shown for 402 errors
    - TypeScript and lint pass
  </done>
</task>

</tasks>

<verification>
1. Build verification:
   ```bash
   pnpm build --filter=@bragdoc/web
   ```

2. Unit test suite (if any tests exist for this component):
   ```bash
   pnpm test --filter=@bragdoc/web
   ```

3. End-to-end flow verification (manual):
   - Log in as free user with 0 credits
   - Navigate to achievements page
   - Select achievements and click "Generate Document"
   - Select document type and click Generate
   - Verify upgrade modal appears (not error toast)
   - Verify modal can be dismissed
</verification>

<success_criteria>
- 402 errors in document generation show upgrade modal
- Modal follows existing pattern from chat-interface.tsx
- No regression in other error handling (401, 400, 500)
- TypeScript compiles, lint passes, build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/07-ux-polish/07-01-SUMMARY.md`
</output>
